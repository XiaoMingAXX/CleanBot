# CleanBot 架构设计文档

## 1. 系统架构概述

CleanBot采用分层架构设计，遵循面向对象的设计思想，使用C语言实现。系统分为以下几个层次：

```
┌─────────────────────────────────────┐
│         Application Layer           │  (应用层)
│         CleanBotApp                 │
└─────────────────────────────────────┘
                  │
┌─────────────────────────────────────┐
│         Module Layer                │  (模块层)
│  Motor │ Encoder │ PID │ Sensor     │
│  Indicator │ Communication          │
└─────────────────────────────────────┘
                  │
┌─────────────────────────────────────┐
│         BSP Layer                   │  (板级支持层)
│  GPIO │ Timer │ UART │ USB          │
└─────────────────────────────────────┘
                  │
┌─────────────────────────────────────┐
│         HAL Layer                   │  (硬件抽象层)
│         STM32 HAL Library           │
└─────────────────────────────────────┘
```

## 2. 模块设计

### 2.1 电机控制模块 (Motor)

**设计思想**: 采用面向对象的设计，使用结构体和函数指针实现多态性。

**核心结构**:
- `Motor_t`: 电机对象结构体
- `MotorVTable_t`: 虚拟函数表（支持多态）

**功能**:
- PWM速度控制
- 方向控制（正转/反转/停止/刹车）
- 速度限制和保护

### 2.2 编码器模块 (Encoder)

**设计思想**: 封装编码器读取和速度计算逻辑。

**核心结构**:
- `Encoder_t`: 编码器对象结构体

**功能**:
- 脉冲计数
- 速度计算 (RPM)
- 增量计算

### 2.3 PID控制器模块 (PID)

**设计思想**: 标准PID控制器实现，支持参数配置和限幅。

**核心结构**:
- `PIDController_t`: PID控制器对象结构体

**功能**:
- PID计算
- 输出限幅
- 积分限幅
- 参数配置

### 2.4 传感器模块 (Sensor)

#### 2.4.1 红外传感器 (IR Sensor)

**设计思想**: 支持NEC协议解码，使用状态机实现。

**核心结构**:
- `IR_Sensor_t`: 红外传感器对象结构体
- `NEC_Decoder_t`: NEC解码器对象结构体

**功能**:
- 红外信号接收
- NEC协议解码
- 数据校验

#### 2.4.2 光电门 (Photo Gate)

**设计思想**: 简单的数字输入传感器。

**核心结构**:
- `PhotoGate_t`: 光电门对象结构体

**功能**:
- 状态检测
- 触发检测

### 2.5 指示器模块 (Indicator)

#### 2.5.1 LED

**设计思想**: 简单的GPIO输出控制。

**核心结构**:
- `LED_t`: LED对象结构体

**功能**:
- 开关控制
- 状态切换

#### 2.5.2 蜂鸣器 (Buzzer)

**设计思想**: 使用PWM产生不同频率的音调。

**核心结构**:
- `Buzzer_t`: 蜂鸣器对象结构体

**功能**:
- 音调输出
- 持续时间控制

### 2.6 通信模块 (Communication)

#### 2.6.1 USB通信 (USB Comm)

**设计思想**: 使用USB CDC虚拟串口，配合环形缓冲区实现数据缓冲。

**核心结构**:
- `USB_Comm_t`: USB通信对象结构体
- `RingBuffer_t`: 环形缓冲区结构体

**功能**:
- 数据发送
- 数据接收
- 连接状态检测

## 3. 数据流设计

### 3.1 控制流程

```
树莓派 (命令)
    ↓
USB通信模块 (接收)
    ↓
应用层 (解析命令)
    ↓
电机控制模块 (设置目标速度)
    ↓
PID控制器 (计算输出)
    ↓
电机驱动 (PWM输出)
    ↓
编码器 (反馈速度)
    ↓
PID控制器 (闭环控制)
```

### 3.2 传感器数据流

```
传感器硬件
    ↓
传感器模块 (读取)
    ↓
应用层 (处理)
    ↓
决策算法 (路径规划/避障)
    ↓
电机控制 (执行动作)
```

## 4. 任务设计 (FreeRTOS)

### 4.1 任务列表

| 任务名称 | 优先级 | 周期 | 功能 |
|---------|--------|------|------|
| CleanBotApp | Normal | 10ms | 主应用逻辑 |
| MotorCtrl | High | 5ms | 电机控制 |
| PIDCtrl | High | 10ms | PID计算 |
| Sensor | Normal | 50ms | 传感器读取 |
| USBComm | Low | 20ms | USB通信处理 |
| Monitor | Low | 1000ms | 系统监控 |

### 4.2 任务间通信

- **队列 (Queue)**: 用于任务间数据传递
- **信号量 (Semaphore)**: 用于资源同步
- **互斥量 (Mutex)**: 用于共享资源保护

## 5. 中断设计

### 5.1 中断优先级

| 中断源 | 优先级 | 说明 |
|--------|--------|------|
| 编码器 | 5 | 高优先级，确保精确计数 |
| USB | 6 | 中等优先级 |
| 外部中断 | 7 | 传感器中断 |
| FreeRTOS | 15 | 最低优先级 |

### 5.2 中断处理原则

1. 中断处理函数尽量简短
2. 复杂处理放到任务中
3. 使用队列传递数据到任务

## 6. 配置管理

### 6.1 配置文件结构

- `hw_config.h`: 硬件配置（引脚、定时器等）
- `system_config.h`: 系统配置（任务优先级、堆栈大小等）

### 6.2 配置原则

1. 所有硬件相关配置集中在 `hw_config.h`
2. 所有系统相关配置集中在 `system_config.h`
3. 使用宏定义，便于修改和移植

## 7. 错误处理

### 7.1 错误类型

- 硬件错误（电机故障、传感器故障等）
- 通信错误（USB通信失败）
- 系统错误（内存不足、任务超时等）

### 7.2 错误处理策略

1. 错误检测和记录
2. 自动恢复（如果可能）
3. 错误上报（通过USB通信）

## 8. 扩展性设计

### 8.1 模块化设计

- 每个模块独立，接口清晰
- 便于添加新功能模块
- 便于替换实现

### 8.2 面向对象设计

- 使用结构体封装数据
- 使用函数指针实现多态
- 便于代码复用

## 9. 性能优化

### 9.1 实时性保证

- 关键任务使用高优先级
- 中断处理尽量简短
- 避免在中断中执行耗时操作

### 9.2 资源优化

- 合理分配堆栈大小
- 使用静态内存分配
- 避免内存碎片

## 10. 测试策略

### 10.1 单元测试

- 每个模块独立测试
- 使用模拟硬件接口

### 10.2 集成测试

- 模块间接口测试
- 系统功能测试

### 10.3 硬件测试

- 实际硬件环境测试
- 性能测试
- 可靠性测试

