# CleanBot USB通信协议文档

## 1. 协议概述

CleanBot使用USB CDC虚拟串口与上位机（树莓派）通信。通信协议采用帧格式，包含帧头、命令、数据长度、数据和校验和。

## 2. 数据包格式

```
+----------+----------+----------+----------+----------+
|  帧头    |  命令    | 数据长度 |   数据   |  校验和  |  帧尾
+----------+----------+----------+----------+----------+
|  0xAA    |  1 Byte  |  1 Byte  |  N Byte  |  1 Byte  |  0x55
+----------+----------+----------+----------+----------+
```

### 2.1 字段说明

- **帧头 (Header)**: 固定为 `0xAA`
- **命令 (Command)**: 命令类型，见命令列表
- **数据长度 (Length)**: 数据字段的字节数 (0-255)
- **数据 (Data)**: 命令数据，根据命令类型不同而不同
- **校验和 (Checksum)**: 从命令字段开始到数据字段结束的异或校验
- **帧尾 (Tail)**: 固定为 `0x55`

### 2.2 校验和计算

```c
uint8_t checksum = 0;
for (int i = 1; i < (2 + dataLen); i++) {  // 从命令字段开始
    checksum ^= packet[i];
}
```

## 3. 命令列表

### 3.1 设置轮电机速度 (CMD_SET_WHEEL_SPEED = 0x01)

**功能**: 设置左右轮电机的目标速度（m/s）

**数据格式**:
```
+----------+----------+
| 左速度   | 右速度   |
+----------+----------+
| 4 Byte   | 4 Byte   |
| (float)  | (float)  |
+----------+----------+
```

**示例**:
```
发送: AA 01 08 [左速度4字节] [右速度4字节] [校验和] 55
应答: AA 80 00 [校验和] 55  // ACK
```

### 3.2 设置边刷电机 (CMD_SET_BRUSH_MOTOR = 0x02)

**功能**: 设置左右边刷电机的档位

**数据格式**:
```
+----------+----------+
| 左边刷   | 右边刷   |
+----------+----------+
| 1 Byte   | 1 Byte   |
+----------+----------+
```

**档位定义**:
- `0`: 关闭
- `1`: 低速
- `2`: 高速

**示例**:
```
发送: AA 02 02 01 02 [校验和] 55  // 左边刷低速，右边刷高速
应答: AA 80 00 [校验和] 55
```

### 3.3 设置水泵电机 (CMD_SET_PUMP_MOTOR = 0x03)

**功能**: 设置水箱增压电机的档位

**数据格式**:
```
+----------+
| 档位     |
+----------+
| 1 Byte   |
+----------+
```

**档位定义**:
- `0`: 关闭
- `1`: 低速
- `2`: 中速
- `3`: 高速

**示例**:
```
发送: AA 03 01 02 [校验和] 55  // 中速
应答: AA 80 00 [校验和] 55
```

### 3.4 设置风机 (CMD_SET_FAN_MOTOR = 0x04)

**功能**: 设置吸尘风机的档位

**数据格式**:
```
+----------+
| 档位     |
+----------+
| 1 Byte   |
+----------+
```

**档位定义**:
- `0`: 关闭
- `1`: 档位1 (1000 RPM)
- `2`: 档位2 (2000 RPM)
- `3`: 档位3 (3000 RPM)
- `4`: 档位4 (4000 RPM)
- `5`: 档位5 (5000 RPM)

**示例**:
```
发送: AA 04 01 03 [校验和] 55  // 档位3
应答: AA 80 00 [校验和] 55
```

### 3.5 获取轮电机速度 (CMD_GET_WHEEL_SPEED = 0x05)

**功能**: 获取当前左右轮电机的实际速度（m/s）

**数据格式**:
```
+----------+----------+
| 左速度   | 右速度   |
+----------+----------+
| 4 Byte   | 4 Byte   |
| (float)  | (float)  |
+----------+----------+
```

**示例**:
```
发送: AA 05 00 [校验和] 55
应答: AA 05 08 [左速度4字节] [右速度4字节] [校验和] 55
```

### 3.6 获取状态 (CMD_GET_STATUS = 0x06)

**功能**: 获取系统状态（预留，后续实现）

**数据格式**: 待定义

### 3.7 复位 (CMD_RESET = 0x07)

**功能**: 复位系统（预留，后续实现）

**数据格式**: 无

### 3.8 应答 (CMD_ACK = 0x80)

**功能**: 命令执行成功应答

**数据格式**: 无数据

### 3.9 错误应答 (CMD_NACK = 0x81)

**功能**: 命令执行失败应答

**数据格式**: 无数据

## 4. 通信流程

### 4.1 设置命令流程

```
上位机                    CleanBot
  |                          |
  |--- 命令帧 -------------->|
  |                          | 处理命令
  |<-- ACK/NACK ------------|
  |                          |
```

### 4.2 查询命令流程

```
上位机                    CleanBot
  |                          |
  |--- 查询命令 ------------>|
  |                          | 处理查询
  |<-- 数据帧 --------------|
  |                          |
```

## 5. 错误处理

1. **校验和错误**: 收到校验和错误的数据包，不处理，不回复
2. **命令错误**: 收到未知命令，回复 NACK
3. **数据长度错误**: 数据长度不符合要求，回复 NACK
4. **参数错误**: 参数超出范围，回复 NACK

## 6. 注意事项

1. 所有多字节数据采用小端序 (Little-Endian)
2. 浮点数采用IEEE 754标准
3. 通信频率建议不超过100Hz
4. 单次数据包最大长度为64字节（USB CDC限制）
5. 上位机发送命令后应等待应答，超时时间建议1秒

## 7. 示例代码（Python）

```python
import struct
import serial

# 打开串口
ser = serial.Serial('/dev/ttyACM0', 115200)

def send_command(cmd, data=None):
    # 构建数据包
    packet = bytearray()
    packet.append(0xAA)  # 帧头
    packet.append(cmd)   # 命令
    
    if data:
        packet.append(len(data))  # 数据长度
        packet.extend(data)       # 数据
    else:
        packet.append(0)  # 数据长度为0
    
    # 计算校验和
    checksum = 0
    for i in range(1, len(packet)):
        checksum ^= packet[i]
    packet.append(checksum)
    
    packet.append(0x55)  # 帧尾
    
    # 发送
    ser.write(packet)
    
    # 接收应答
    response = ser.read(5)  # 最小应答长度
    return response

# 设置轮电机速度
left_speed = 0.5  # m/s
right_speed = 0.5  # m/s
data = struct.pack('<ff', left_speed, right_speed)
send_command(0x01, data)

# 设置边刷电机
data = bytes([1, 2])  # 左边刷低速，右边刷高速
send_command(0x02, data)

# 获取轮电机速度
response = send_command(0x05)
if len(response) >= 13:
    left_speed, right_speed = struct.unpack('<ff', response[3:11])
    print(f"Left: {left_speed} m/s, Right: {right_speed} m/s")
```

## 8. 后续扩展

协议框架已搭建完成，后续可根据需要添加以下功能：

1. 传感器数据上报
2. 系统状态查询
3. 参数配置
4. 固件升级
5. 日志记录

